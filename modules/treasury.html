<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury Dashboard | Finance OS</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="module-page">
    <div class="module-header-bar">
        <div class="container">
            <a href="../index.html" class="back-button">← Back to Home</a>
            <h1 class="module-title">Treasury Dashboard</h1>
            <p class="module-subtitle">13-Week Cash Forecast & Runway Analysis</p>
        </div>
    </div>

    <div class="dashboard">
        <div class="container">
            <!-- Upload Control -->
            <div class="controls">
                <div class="control-group">
                    <label for="cashUpload">Upload Cash Flow Data (CSV):</label>
                    <input type="file" id="cashUpload" accept=".csv" style="font-size: 0.875rem;">
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-grid" id="kpiGrid">
                <!-- Populated by JavaScript -->
            </div>

            <!-- Cash Flow Chart -->
            <div class="chart-container">
                <h3>13-Week Cash Flow Projection</h3>
                <div style="height: 400px; position: relative;">
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>

            <!-- Runway Chart -->
            <div class="chart-container">
                <h3>Cash Runway Analysis</h3>
                <div style="height: 400px; position: relative;">
                    <canvas id="runwayChart"></canvas>
                </div>
            </div>

            <!-- Cash Flow Table -->
            <div class="data-table-container">
                <h3>Weekly Cash Flow Details</h3>
                <div style="overflow-x: auto;">
                    <table id="cashTable">
                        <thead>
                            <tr>
                                <th>Week Ending</th>
                                <th class="number">Cash Inflows</th>
                                <th class="number">Cash Outflows</th>
                                <th class="number">Net Cash Flow</th>
                                <th class="number">Ending Cash</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="cashTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Funding Scenario -->
            <div class="commentary-section" style="background: white; border: 2px solid var(--gray-200); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: 1.25rem; color: var(--gray-900); margin-bottom: var(--spacing-md); font-weight: 700; border-bottom: 2px solid var(--gray-200); padding-bottom: var(--spacing-xs);">Funding Plan Assumptions</h3>
                <ul id="fundingAssumptions" style="list-style: none; padding: 0;">
                    <!-- Populated by JavaScript -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                data.push(row);
            }
            
            return data;
        }

        function formatCurrency(value, decimals = 0) {
            const num = parseFloat(value);
            if (isNaN(num)) return '$0';
            return '$' + num.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Data loading
        let cashData = [];
        let charts = {};

        async function loadData() {
            try {
                const response = await fetch('../data/cash_13week.csv');
                const text = await response.text();
                cashData = parseCSV(text);
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function initializeDashboard() {
            calculateMetrics();
            createCharts();
            updateTable();
            generateFundingPlan();
        }

        function calculateMetrics() {
            const currentWeek = cashData[0];
            const endingWeek = cashData[cashData.length - 1];
            
            const currentCash = parseFloat(currentWeek.ending_cash);
            const projectedCash = parseFloat(endingWeek.ending_cash);
            const cashChange = projectedCash - currentCash;
            
            // Calculate average weekly burn
            const totalOutflows = cashData.reduce((sum, week) => 
                sum + parseFloat(week.cash_outflows), 0);
            const avgWeeklyBurn = totalOutflows / cashData.length;
            
            // Calculate runway in weeks and months
            const runwayWeeks = currentCash / avgWeeklyBurn;
            const runwayMonths = runwayWeeks / 4.33; // Average weeks per month
            
            // Calculate total inflows and outflows
            const totalInflows = cashData.reduce((sum, week) => 
                sum + parseFloat(week.cash_inflows), 0);
            
            const netCashFlow = totalInflows - totalOutflows;
            
            // Determine runway status
            let runwayStatus = 'healthy';
            let runwayClass = 'positive';
            if (runwayMonths < 6) {
                runwayStatus = 'critical - funding needed';
                runwayClass = 'negative';
            } else if (runwayMonths < 12) {
                runwayStatus = 'attention required';
                runwayClass = 'negative';
            }
            
            const kpiHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Current Cash Balance</div>
                    <div class="kpi-value">${formatCurrency(currentCash / 1000000, 2)}M</div>
                    <div class="kpi-change">As of ${currentWeek.week_ending}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">13-Week Projection</div>
                    <div class="kpi-value">${formatCurrency(projectedCash / 1000000, 2)}M</div>
                    <div class="kpi-change ${cashChange >= 0 ? 'positive' : 'negative'}">
                        ${cashChange >= 0 ? '↑' : '↓'} ${formatCurrency(Math.abs(cashChange))}
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Cash Runway</div>
                    <div class="kpi-value">${runwayMonths.toFixed(1)}mo</div>
                    <div class="kpi-change ${runwayClass}">
                        ~${Math.floor(runwayWeeks)} weeks
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Avg Weekly Burn</div>
                    <div class="kpi-value">${formatCurrency(avgWeeklyBurn / 1000)}K</div>
                    <div class="kpi-change">Operating rate</div>
                </div>
            `;
            
            document.getElementById('kpiGrid').innerHTML = kpiHTML;
        }

        function createCharts() {
            const labels = cashData.map(row => formatDate(row.week_ending));
            
            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            charts.cashFlow = new Chart(cashFlowCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ending Cash',
                            data: cashData.map(row => parseFloat(row.ending_cash)),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Weekly Inflows',
                            data: cashData.map(row => parseFloat(row.cash_inflows)),
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            tension: 0.3,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Weekly Outflows',
                            data: cashData.map(row => parseFloat(row.cash_outflows)),
                            borderColor: '#ef4444',
                            borderDash: [5, 5],
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Cash Balance'
                            },
                            ticks: {
                                callback: value => '$' + (value / 1000000).toFixed(1) + 'M'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Weekly Flows'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: value => '$' + (value / 1000).toFixed(0) + 'K'
                            }
                        }
                    }
                }
            });
            
            // Runway Chart (Waterfall of cash position)
            const runwayCtx = document.getElementById('runwayChart').getContext('2d');
            const avgWeeklyBurn = cashData.reduce((sum, week) => 
                sum + parseFloat(week.cash_outflows), 0) / cashData.length;
            const currentCash = parseFloat(cashData[0].ending_cash);
            
            const weeksOfRunway = Math.floor(currentCash / avgWeeklyBurn);
            const runwayLabels = Array.from({length: Math.min(weeksOfRunway, 52)}, (_, i) => `Week ${i + 1}`);
            const runwayData = runwayLabels.map((_, i) => currentCash - (avgWeeklyBurn * i));
            
            charts.runway = new Chart(runwayCtx, {
                type: 'line',
                data: {
                    labels: runwayLabels,
                    datasets: [{
                        label: 'Projected Cash Balance',
                        data: runwayData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    label: {
                                        content: 'Zero Cash',
                                        enabled: true
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + (value / 1000000).toFixed(1) + 'M'
                            }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('cashTableBody');
            tbody.innerHTML = cashData.map(row => {
                const netFlow = parseFloat(row.net_cash_flow);
                const flowClass = netFlow >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${row.week_ending}</td>
                        <td class="number positive">${formatCurrency(row.cash_inflows)}</td>
                        <td class="number negative">${formatCurrency(row.cash_outflows)}</td>
                        <td class="number ${flowClass}">${formatCurrency(row.net_cash_flow)}</td>
                        <td class="number">${formatCurrency(row.ending_cash)}</td>
                        <td>${row.notes}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateFundingPlan() {
            const avgWeeklyBurn = cashData.reduce((sum, week) => 
                sum + parseFloat(week.cash_outflows), 0) / cashData.length;
            const currentCash = parseFloat(cashData[0].ending_cash);
            const runwayMonths = (currentCash / avgWeeklyBurn) / 4.33;
            
            let assumptions = [];
            
            if (runwayMonths < 6) {
                assumptions = [
                    `⚠️ Critical runway: ${runwayMonths.toFixed(1)} months remaining`,
                    `Immediate funding required: Target $${((avgWeeklyBurn * 52 * 1.5) / 1000000).toFixed(1)}M for 18-month runway`,
                    `Recommended: Series A/B fundraise within next 60 days`,
                    `Alternative: Bridge financing of $${((avgWeeklyBurn * 26) / 1000000).toFixed(1)}M to extend 6 months`,
                    `Cost reduction contingency: Reduce burn by 20-30% if funding delayed`
                ];
            } else if (runwayMonths < 12) {
                assumptions = [
                    `⚠️ Moderate runway: ${runwayMonths.toFixed(1)} months remaining`,
                    `Fundraising timeline: Initiate Series A/B process within 3 months`,
                    `Target raise: $${((avgWeeklyBurn * 52 * 2) / 1000000).toFixed(1)}M for 24-month runway plus growth capital`,
                    `Maintain current burn rate while optimizing unit economics`,
                    `Review quarterly for burn rate adjustments based on growth metrics`
                ];
            } else {
                assumptions = [
                    `✓ Healthy runway: ${runwayMonths.toFixed(1)} months of cash available`,
                    `Current cash position supports operations through ${new Date(Date.now() + runwayMonths * 30 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}`,
                    `Opportunistic fundraising: Can wait for optimal market conditions`,
                    `Target next raise: $${((avgWeeklyBurn * 52 * 2) / 1000000).toFixed(1)}M at improved valuation`,
                    `Focus on profitability path and unit economics optimization`
                ];
            }
            
            assumptions.push(`Average weekly burn rate: ${formatCurrency(avgWeeklyBurn)} per week`);
            assumptions.push(`Assumes current expense run-rate; adjust for planned hiring/expansion`);
            
            const assumptionsHTML = assumptions.map(a => {
                const style = a.startsWith('⚠️') ? 'color: var(--warning); font-weight: 600;' : 
                              a.startsWith('✓') ? 'color: var(--secondary); font-weight: 600;' : '';
                return `<li style="padding: var(--spacing-sm) 0; padding-left: var(--spacing-md); position: relative; line-height: 1.7; ${style}">${a}</li>`;
            }).join('');
            
            document.getElementById('fundingAssumptions').innerHTML = assumptionsHTML;
        }

        // Initialize
        loadData();

        // CSV Upload Handler
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('cashUpload')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const text = await file.text();
                    cashData = parseCSV(text);
                    initializeDashboard();
                    alert('Custom cash flow CSV loaded!');
                }
            });
        });
    </script>
</body>
</html>
