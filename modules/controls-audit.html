<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controls & Audit Trail | Finance OS</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>

<body class="module-page">
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>Finance Operating System</h1>
      </div>
    </div>
  </nav>

  <div class="module-header-bar">
    <div class="container">
      <a href="../index.html" class="back-button">← Back to Home</a>
      <h1 class="module-title">Controls &amp; Audit Trail</h1>
      <p class="module-subtitle">Source → Validation → Approval → Posting → Reporting (with checkpoints)</p>
    </div>
  </div>

  <div class="dashboard">
    <div class="container">

      <!-- Controls -->
      <div class="controls">
        <div class="control-group">
          <label for="process">Process:</label>
          <select id="process">
            <option value="p2p" selected>Procure-to-Pay (P2P)</option>
            <option value="o2c">Order-to-Cash (O2C)</option>
            <option value="r2r">Record-to-Report (R2R)</option>
          </select>
        </div>
        <div class="control-group">
          <label for="riskLevel">Risk Level:</label>
          <select id="riskLevel">
            <option value="low">Low</option>
            <option value="med" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="control-group">
          <label for="evidenceMode">Evidence Mode:</label>
          <select id="evidenceMode">
            <option value="lean" selected>Lean (fast)</option>
            <option value="audit">Audit-ready (strict)</option>
          </select>
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid" id="kpiGrid"></div>

      <!-- Workflow Map -->
      <div class="chart-container">
        <h3>Workflow Map</h3>
        <div class="flow" id="flow"></div>
        <p style="margin-top: 0.75rem; font-size: 0.875rem; opacity: 0.9;">
          ELI5: This is like a “bouncer line” for your numbers. If a transaction can’t show ID (evidence), it doesn’t get inside your books.
        </p>
      </div>

      <!-- Control Checkpoints -->
      <div class="data-table-container">
        <h3>Control Checkpoints</h3>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th style="min-width:220px;">Checkpoint</th>
                <th style="min-width:160px;">Risk Addressed</th>
                <th style="min-width:160px;">Control Type</th>
                <th style="min-width:160px;">Evidence</th>
                <th style="min-width:120px;">Owner</th>
                <th style="min-width:140px;">Implemented</th>
              </tr>
            </thead>
            <tbody id="controlsBody"></tbody>
          </table>
        </div>
        <div style="margin-top: 0.75rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
          <button class="module-button" id="enableAllBtn" type="button">Enable All</button>
          <button class="module-button" id="disableAllBtn" type="button">Disable All</button>
          <button class="module-button" id="copyPackBtn" type="button">Copy Audit Pack</button>
        </div>
      </div>

    </div>
  </div>

  <style>
    .flow{
      display:grid;
      grid-template-columns: repeat(5, minmax(170px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }
    .flow-card{
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 0.9rem;
      background: rgba(255,255,255,0.6);
      position: relative;
    }
    .flow-title{
      font-weight: 800;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }
    .flow-desc{
      font-size: 0.875rem;
      opacity: 0.95;
      margin: 0.35rem 0 0;
      line-height: 1.4;
    }
    .flow-arrow{
      position:absolute;
      right:-12px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
      font-size: 1.2rem;
    }
    .badge{
      display:inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(0,0,0,0.12);
      opacity: 0.9;
      margin-left: 0.35rem;
    }
    @media (max-width: 1100px) {
      .flow{ grid-template-columns: 1fr; }
      .flow-arrow{ display:none; }
    }
  </style>

  <script>
    function copyText(text){ navigator.clipboard.writeText(text).then(()=>alert('Copied!')); }

    const workflow = [
      { key:'source', title:'1) Source', desc:'Capture transaction + attach source document.' },
      { key:'validate', title:'2) Validation', desc:'Check completeness, correctness, and policy match.' },
      { key:'approve', title:'3) Approval', desc:'Independent review + authorization.' },
      { key:'post', title:'4) Posting', desc:'Record in GL with locked audit trail.' },
      { key:'report', title:'5) Reporting', desc:'Outputs tie-out + commentary.' },
    ];

    const library = {
      p2p: [
        { cp:'3-way match', risk:'Overpayment / fraud', type:'Preventive', evidence:'PO + GRN + Invoice', owner:'AP', on:true },
        { cp:'Vendor master change log', risk:'Fake vendor', type:'Detective', evidence:'Change report + approver', owner:'Finance', on:true },
        { cp:'Payment run approval', risk:'Unauthorized payment', type:'Preventive', evidence:'Payment batch sign-off', owner:'Controller', on:true },
        { cp:'Bank recon review', risk:'Cash misstatement', type:'Detective', evidence:'Recon + reviewer sign', owner:'Finance', on:true },
      ],
      o2c: [
        { cp:'Pricing approval', risk:'Margin leakage', type:'Preventive', evidence:'Approved price list', owner:'Sales Ops', on:true },
        { cp:'Credit checks', risk:'Bad debt', type:'Preventive', evidence:'Credit memo + approval', owner:'Finance', on:true },
        { cp:'Revenue cutoff test', risk:'Revenue misstatement', type:'Detective', evidence:'Shipment/service proof', owner:'Accounting', on:true },
        { cp:'AR aging review', risk:'Overstated AR', type:'Detective', evidence:'Aging + action log', owner:'AR', on:true },
      ],
      r2r: [
        { cp:'JE approval workflow', risk:'Manual override', type:'Preventive', evidence:'JE form + approver', owner:'Accounting', on:true },
        { cp:'Close checklist sign-off', risk:'Missed steps', type:'Preventive', evidence:'Checklist + dates', owner:'Finance Lead', on:true },
        { cp:'Variance review', risk:'Silent errors', type:'Detective', evidence:'Variance commentary', owner:'FP&A', on:true },
        { cp:'Access review (monthly)', risk:'Privilege abuse', type:'Detective', evidence:'User access report', owner:'IT/Finance', on:true },
      ]
    };

    function renderFlow(){
      const el = document.getElementById('flow');
      el.innerHTML = workflow.map((w, i) => `
        <div class="flow-card">
          <div class="flow-title">${w.title}<span class="badge">${w.key.toUpperCase()}</span></div>
          <p class="flow-desc">${w.desc}</p>
          ${i < workflow.length - 1 ? `<div class="flow-arrow">→</div>` : ``}
        </div>
      `).join('');
    }

    function getRules(){
      const proc = document.getElementById('process').value;
      const risk = document.getElementById('riskLevel').value;
      const mode = document.getElementById('evidenceMode').value;

      let rules = JSON.parse(JSON.stringify(library[proc] || []));

      // risk dial: higher risk adds stricter evidence wording
      if (risk === 'high') {
        rules = rules.map(r => ({...r, evidence: r.evidence + ' + screenshot/export' }));
      } else if (risk === 'med') {
        rules = rules.map(r => ({...r, evidence: r.evidence + ' + reference ID' }));
      }

      // evidence mode: lean reduces evidence asks
      if (mode === 'lean') {
        rules = rules.map(r => ({...r, evidence: r.evidence.replace(' + screenshot/export','').replace(' + reference ID','') }));
      }

      return rules;
    }

    let rulesState = [];

    function renderTable(){
      rulesState = getRules();
      const body = document.getElementById('controlsBody');

      body.innerHTML = rulesState.map((r, idx) => `
        <tr>
          <td>${r.cp}</td>
          <td>${r.risk}</td>
          <td>${r.type}</td>
          <td>${r.evidence}</td>
          <td>${r.owner}</td>
          <td>
            <select data-idx="${idx}" style="width:100%; padding:0.35rem;">
              <option value="true" ${r.on ? 'selected':''}>Yes</option>
              <option value="false" ${!r.on ? 'selected':''}>No</option>
            </select>
          </td>
        </tr>
      `).join('');

      body.querySelectorAll('select').forEach(s => {
        s.addEventListener('change', (e) => {
          const idx = Number(e.target.dataset.idx);
          rulesState[idx].on = (e.target.value === 'true');
          renderKPIs();
        });
      });

      renderKPIs();
    }

    function renderKPIs(){
      const enabled = rulesState.filter(r => r.on).length;
      const total = rulesState.length;
      const coverage = total ? Math.round((enabled/total)*100) : 0;

      const risk = document.getElementById('riskLevel').value;
      const scoreBase = risk === 'high' ? 60 : risk === 'med' ? 75 : 85;
      const confidence = Math.min(98, Math.round(scoreBase + (coverage * 0.35)));

      const kpiHTML = `
        <div class="kpi-card">
          <div class="kpi-label">Controls Enabled</div>
          <div class="kpi-value">${enabled}/${total}</div>
          <div class="kpi-change ${coverage >= 75 ? 'positive' : 'negative'}">${coverage}% coverage</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Audit Confidence</div>
          <div class="kpi-value">${confidence}%</div>
          <div class="kpi-change">Heuristic score</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Evidence Mode</div>
          <div class="kpi-value">${document.getElementById('evidenceMode').value === 'audit' ? 'Strict' : 'Lean'}</div>
          <div class="kpi-change">Documentation depth</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Process</div>
          <div class="kpi-value">${document.getElementById('process').value.toUpperCase()}</div>
          <div class="kpi-change">Control library loaded</div>
        </div>
      `;
      document.getElementById('kpiGrid').innerHTML = kpiHTML;
    }

    document.getElementById('enableAllBtn').addEventListener('click', () => {
      rulesState.forEach(r => r.on = true);
      renderTable();
    });

    document.getElementById('disableAllBtn').addEventListener('click', () => {
      rulesState.forEach(r => r.on = false);
      renderTable();
    });

    document.getElementById('copyPackBtn').addEventListener('click', () => {
      const enabled = rulesState.filter(r => r.on);
      const lines = [
        'Checkpoint\tRisk\tType\tEvidence\tOwner',
        ...enabled.map(r => `${r.cp}\t${r.risk}\t${r.type}\t${r.evidence}\t${r.owner}`)
      ];
      copyText(lines.join('\n'));
    });

    ['process','riskLevel','evidenceMode'].forEach(id => {
      document.getElementById(id).addEventListener('change', renderTable);
    });

    renderFlow();
    renderTable();
  </script>
</body>
</html>
